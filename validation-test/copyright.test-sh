#!/usr/bin/env bash

# This test validates that all source files have _correct_ copyright notices.

DEBUG=true
function print() {
	$DEBUG && echo $@
}

set -euo pipefail

# This is pretty general, it will match any line with the word "Copyright" and 4 numbers
COPYRIGHT_EXISTS_PATTERN="Copyright .* \\d{4}"

COMMENT_PATTERN="(\\/\\/|\#|  *)"
COPYRIGHT_IS_CONFORMANT_PATTERN=("$COMMENT_PATTERN This source file is part of the Swift.org open source project\n(\/\/|#) Copyright \(c\) ((\d{4})|\d{4} - \d{4}))"



# Takes a filepath as the sole argument
function dates() {
	local G_LOG_OUTPUT=$(git log --format="%ad" --date="format:%Y" -- $@)

	local CREATED_AT=$(tail -1 <<< $G_LOG_OUTPUT)
	local LAST_EDIT=$(head -1 <<< $G_LOG_OUTPUT)

	print "created at $CREATED_AT, last edit at $LAST_EDIT"
}

# Takes a filepath as the sole argument
function has_copyright_header() {
	if grep --silent $COPYRIGHT_EXISTS_PATTERN $@; then
		print "file has a copyright notice"
	else
		print "file doesn't have a copyright notice"
		exit 0
	fi
}

function copyright_header_is_conformant() {
	if grep --silent $COPYRIGHT_IS_CONFORMANT_PATTERN $@; then
		print "copyright is formatted conformantly"
	else
		print "incorrectly formatted copyright header"
		exit 1
	fi
}

print "testing $@"
dates $@
has_copyright_header $@
copyright_header_is_conformant $@
